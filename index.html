<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Simulador de crédito habitação (PT) — FR/PT</title>
  <style>
    :root{
      --green:#b5d200;
      --green2:#93c100;
      --bg:#ffffff;
      --text:#1b1f24;
      --muted:#6b7280;
      --card:#eef6ff;
      --border:#e5e7eb;
      --btn:#a01873;
      --btn2:#8a1363;
      --barLoan:#10b3b3;
      --barInterest:#0b7a7a;
      --barSavings:#86efac;
      --barTaxes:#c8a100;
      --barPrice:#f0cf00;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--text); background:var(--bg);}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px;}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:14px;}
    h1{font-size:28px;margin:0;font-weight:800;}
    .toplinks{display:flex;gap:14px;align-items:center;color:#2563eb;font-size:14px;white-space:nowrap}
    .lang{display:flex;gap:8px;align-items:center}
    .lang select{padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff}
    .grid{display:grid;grid-template-columns:1.1fr 0.9fr;gap:22px;align-items:start;}
    @media (max-width: 960px){ .grid{grid-template-columns:1fr;} }

    /* Left form */
    .field{margin:14px 0;}
    .labelrow{display:flex;align-items:center;justify-content:space-between;gap:10px;}
    label{font-size:14px;color:#111827;font-weight:650;}
    .help{font-size:12px;color:var(--muted);}
    .inputrow{display:flex;align-items:center;gap:10px;margin-top:8px;}
    input[type="number"], input[type="text"], select{
      width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; font-size:16px;
    }
    .range{
      width:100%;
      appearance:none;height:6px;border-radius:999px;background:#dfe7c3; outline:none;
    }
    .range::-webkit-slider-thumb{
      appearance:none;width:22px;height:22px;border-radius:50%;
      background:var(--green); border:3px solid #93b600; cursor:pointer;
    }
    .miniLink{font-size:13px;color:#2563eb;text-decoration:none;}
    .note{
      background:#e9f4ff;border:1px solid #cfe7ff;color:#1f4e79;
      padding:10px 12px;border-radius:10px;font-size:13px;display:flex;gap:10px;align-items:flex-start;
    }
    .note .i{font-weight:900;line-height:1; margin-top:2px}
    .radioRow{display:flex;gap:14px;align-items:center;margin-top:8px;flex-wrap:wrap;}
    .radioRow label{font-weight:600;font-size:14px;color:#374151}
    .pill{
      display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--border);
      border-radius:999px;background:#fff;
    }
    .rateBox{display:flex;align-items:center;gap:10px;}
    .rateBox button{
      width:36px;height:36px;border-radius:10px;border:1px solid var(--border);background:#fff;
      font-size:18px;cursor:pointer;
    }
    .rateBox .rate{
      min-width:110px;text-align:center;border:1px solid var(--border);border-radius:10px;padding:8px 10px;background:#fff;
      font-weight:700;
    }

    /* Right card */
    .card{
      background:var(--card); border:1px solid #d7e9ff; border-radius:12px; padding:16px;
    }
    .card h2{margin:0 0 8px 0;font-size:16px;font-weight:800;text-align:center;color:#111827;}
    .bigMoney{font-size:34px;font-weight:900;text-align:center;margin:0 0 14px 0;}
    .row{display:flex;justify-content:space-between;gap:12px;padding:8px 0;font-size:14px;color:#111827;}
    .row .mut{color:var(--muted)}
    .divider{height:1px;background:#d7e9ff;margin:10px 0;}
    .stackLegend{display:grid;grid-template-columns:16px 1fr auto;gap:10px;align-items:center;font-size:14px;padding:7px 0;}
    .sq{width:12px;height:12px;border-radius:3px;}
    .btn{
      width:100%; border:0; background:var(--btn); color:#fff; padding:12px 14px;
      border-radius:10px;font-weight:800;font-size:15px;cursor:pointer;
    }
    .btn:hover{background:var(--btn2);}
    .smallLink{display:inline-block;margin-top:8px;color:#2563eb;text-decoration:none;font-size:13px;}

    /* Stacked bar (like screenshot) */
    .barWrap{margin:10px 0 8px 0;}
    .barLabelRow{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-bottom:6px;}
    .bar{
      width:100%;height:18px;border-radius:999px;overflow:hidden;background:#e6eef7;border:1px solid #d7e9ff;
      display:flex;
    }
    .seg{height:100%;}
    .seg.price{background:var(--barPrice);}
    .seg.taxes{background:var(--barTaxes);}
    .seg.loan{background:var(--barLoan);}
    .seg.interest{background:var(--barInterest);}
    .seg.savings{background:var(--barSavings);}
    .underBar{
      display:flex;justify-content:space-between;gap:10px;font-size:12px;color:var(--muted);margin-top:6px;
    }

    /* Modal table */
    dialog{border:1px solid var(--border);border-radius:12px;max-width:820px;width:92vw;}
    dialog::backdrop{background:rgba(0,0,0,.35);}
    table{width:100%;border-collapse:collapse;font-size:13px;}
    th,td{padding:10px 8px;border-bottom:1px solid var(--border);text-align:right;}
    th:first-child, td:first-child{text-align:left;}
    .dlgTop{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px;}
    .x{border:1px solid var(--border);background:#fff;border-radius:10px;padding:8px 10px;cursor:pointer;}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1 id="title">Simulador do crédito habitação</h1>
      </div>
      <div class="lang">
        <div class="toplinks">
          <a class="miniLink" href="javascript:void(0)" id="legalLink">Intermediação de crédito · Informação legal</a>
        </div>
        <select id="lang">
          <option value="pt">PT</option>
          <option value="fr">FR</option>
        </select>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT -->
      <section>
        <div class="field">
          <div class="labelrow">
            <label id="lblPrice">Preço do imóvel</label>
            <input id="price" type="number" step="1000" min="0" value="495000" style="max-width:220px">
          </div>
          <div class="inputrow">
            <input class="range" id="priceR" type="range" min="50000" max="1500000" step="1000" value="495000">
          </div>
          <a class="miniLink" id="calcSpend" href="javascript:void(0)">Calcular o valor que podes gastar</a>
        </div>

        <div class="field">
          <div class="labelrow">
            <label id="lblSavings">Poupanças</label>
            <div style="display:flex;gap:10px;align-items:center;">
              <input id="savings" type="number" step="500" min="0" value="148500" style="max-width:220px">
              <div class="help" id="savingsPct">30%</div>
            </div>
          </div>
          <div class="inputrow">
            <input class="range" id="savingsR" type="range" min="0" max="600000" step="500" value="148500">
          </div>
          <div class="note" style="margin-top:10px">
            <div class="i">i</div>
            <div id="noteBank">
              Lembra-te que os bancos normalmente pedem uma contribuição mínima de 10% mais despesas.
            </div>
          </div>
        </div>

        <div class="field">
          <div class="labelrow">
            <label id="lblYears">Prazo em anos</label>
            <input id="years" type="number" min="1" max="40" value="13" style="max-width:220px">
          </div>
          <div class="inputrow">
            <input class="range" id="yearsR" type="range" min="1" max="40" step="1" value="13">
          </div>
        </div>

        <div class="field">
          <div class="labelrow">
            <label id="lblRateType">Tipo de taxa de juros</label>
          </div>
          <div class="radioRow">
            <span class="pill">
              <input type="radio" name="rateType" id="fixed" value="fixed" checked>
              <label for="fixed" id="lblFixed">Fixa</label>
            </span>
            <span class="pill">
              <input type="radio" name="rateType" id="variable" value="variable">
              <label for="variable" id="lblVar">Variável</label>
            </span>

            <div class="rateBox" style="margin-left:auto">
              <button id="minus">−</button>
              <div class="rate" id="rateBox">3,60 %</div>
              <button id="plus">+</button>
            </div>
          </div>

          <div id="varBox" style="margin-top:10px;display:none">
            <div class="inputrow" style="gap:10px">
              <div style="flex:1">
                <div class="help" id="lblEuribor">Euribor (%)</div>
                <input id="euribor" type="number" step="0.01" value="3.00">
              </div>
              <div style="flex:1">
                <div class="help" id="lblSpread">Spread (%)</div>
                <input id="spread" type="number" step="0.01" value="1.00">
              </div>
              <div style="flex:1">
                <div class="help" id="lblRev">Revisão (meses)</div>
                <select id="rev">
                  <option value="3">3</option>
                  <option value="6">6</option>
                  <option value="12" selected>12</option>
                </select>
              </div>
            </div>
            <div class="help" id="varHint" style="margin-top:6px">
              Estimativa com Euribor constante (podes depois adicionar cenários).
            </div>
          </div>
        </div>

        <div class="field">
          <div class="labelrow">
            <label id="lblLoc">Localização do imóvel</label>
            <select id="region" style="max-width:220px">
              <option value="continente" selected>Continente</option>
              <option value="acores">Açores</option>
            </select>
          </div>
        </div>

        <div class="field">
          <div class="labelrow">
            <label id="lblHouseType">Tipo de casa</label>
          </div>
          <div class="radioRow">
            <span class="pill">
              <input type="radio" name="use" id="hpp" value="hpp" checked>
              <label for="hpp" id="lblHpp">Principal</label>
            </span>
            <span class="pill">
              <input type="radio" name="use" id="nonhpp" value="nonhpp">
              <label for="nonhpp" id="lblNonHpp">Secundária</label>
            </span>
          </div>
        </div>

        <div class="field">
          <div class="labelrow">
            <label id="lblAge">Tens 35 anos ou menos?</label>
          </div>
          <div class="radioRow">
            <span class="pill">
              <input type="radio" name="age" id="ageYes" value="yes">
              <label for="ageYes" id="lblYes">Sim</label>
            </span>
            <span class="pill">
              <input type="radio" name="age" id="ageNo" value="no" checked>
              <label for="ageNo" id="lblNo">Não</label>
            </span>
          </div>
        </div>

        <div class="field" style="margin-top:16px">
          <div class="labelrow">
            <label id="lblTaxesBox">Impostos e despesas (detalhe)</label>
            <div class="help" id="taxHint">Editável</div>
          </div>
          <div class="inputrow" style="gap:10px">
            <div style="flex:1">
              <div class="help" id="lblVpt">VPT (opcional)</div>
              <input id="vpt" type="number" placeholder="—" step="1000">
            </div>
            <div style="flex:1">
              <div class="help" id="lblOther">Outras despesas (€)</div>
              <input id="otherFees" type="number" value="1500" step="50">
            </div>
          </div>
          <div class="help" style="margin-top:6px" id="taxExplain">
            IMT + Imposto do Selo (0,8%) + IS do crédito + outras despesas.
          </div>
        </div>
      </section>

      <!-- RIGHT -->
      <aside class="card">
        <h2 id="cardTitle">A tua prestação mensal</h2>
        <p class="bigMoney" id="monthly">—</p>

        <div class="row">
          <div><span id="lblLoan">Valor crédito habitação</span> <span class="muted">ⓘ</span></div>
          <div id="loan">—</div>
        </div>
        <div class="row">
          <div><span id="lblLtv">Percentagem de financiamento</span> <span class="muted">ⓘ</span></div>
          <div id="ltv">—</div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div><span class="sq" style="background:var(--barPrice);display:inline-block;vertical-align:middle;margin-right:8px"></span><span id="lblPrice2">Preço do imóvel</span></div>
          <div id="priceOut">—</div>
        </div>
        <div class="row">
          <div><span class="sq" style="background:var(--barTaxes);display:inline-block;vertical-align:middle;margin-right:8px"></span><span id="lblTaxes">Impostos e despesas da compra</span> <span class="muted">ⓘ</span></div>
          <div id="taxesOut">—</div>
        </div>

        <div class="row" style="font-weight:900">
          <div id="lblTotalCost">Custo total do imóvel</div>
          <div id="totalCost">—</div>
        </div>

        <div class="barWrap">
          <div class="barLabelRow">
            <div id="lblSavingsBar">A tua poupança disponível</div>
            <div id="lblCreditBar">Crédito à Habitação</div>
            <div id="lblInterestBar">Juro</div>
          </div>
          <div class="bar" aria-label="Stacked bar">
            <div class="seg savings" id="segSavings" title="Poupanças"></div>
            <div class="seg loan" id="segLoan" title="Crédito"></div>
            <div class="seg interest" id="segInterest" title="Juros"></div>
          </div>
          <div class="underBar">
            <span id="underSavings"> </span>
            <span id="underLoan"> </span>
            <span id="underInterest"> </span>
          </div>
        </div>

        <div class="stackLegend">
          <div class="sq" style="background:var(--barSavings)"></div>
          <div id="legSavings">Poupanças</div>
          <div id="legSavingsVal">—</div>
        </div>
        <div class="stackLegend">
          <div class="sq" style="background:var(--barLoan)"></div>
          <div id="legLoan">Valor crédito habitação</div>
          <div id="legLoanVal">—</div>
        </div>
        <div class="stackLegend">
          <div class="sq" style="background:var(--barInterest)"></div>
          <div id="legInterest">Juros crédito habitação</div>
          <div id="legInterestVal">—</div>
        </div>

        <div class="row" style="font-weight:900">
          <div id="lblTotalWithLoan">Valor total com crédito habitação</div>
          <div id="totalWithLoan">—</div>
        </div>

        <a class="smallLink" href="javascript:void(0)" id="amortLink">Ver tabela de amortização</a>

        <div style="height:10px"></div>
        <button class="btn" id="cta">Encontrar crédito habitação</button>
      </aside>
    </div>
  </div>

  <dialog id="dlg">
    <div class="dlgTop">
      <strong id="dlgTitle">Tabela de amortização (estimativa)</strong>
      <button class="x" id="closeDlg">Fechar</button>
    </div>
    <div style="max-height:60vh;overflow:auto">
      <table>
        <thead>
          <tr>
            <th id="thMonth">Mês</th>
            <th id="thPayment">Prestação</th>
            <th id="thInterest">Juro</th>
            <th id="thPrincipal">Capital</th>
            <th id="thBalance">Saldo</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </dialog>

<script>
/** ===============================
 *  1) I18N (PT / FR) — labels only
 *  =============================== */
const I18N = {
  pt: {
    title:"Simulador do crédito habitação",
    cardTitle:"A tua prestação mensal",
    calcSpend:"Calcular o valor que podes gastar",
    noteBank:"Lembra-te que os bancos normalmente pedem uma contribuição mínima de 10% mais despesas.",
    lblPrice:"Preço do imóvel",
    lblSavings:"Poupanças",
    lblYears:"Prazo em anos",
    lblRateType:"Tipo de taxa de juros",
    lblFixed:"Fixa",
    lblVar:"Variável",
    lblEuribor:"Euribor (%)",
    lblSpread:"Spread (%)",
    lblRev:"Revisão (meses)",
    varHint:"Estimativa com Euribor constante (podes depois adicionar cenários).",
    lblLoc:"Localização do imóvel",
    lblHouseType:"Tipo de casa",
    lblHpp:"Principal",
    lblNonHpp:"Secundária",
    lblAge:"Tens 35 anos ou menos?",
    lblYes:"Sim",
    lblNo:"Não",
    lblTaxesBox:"Impostos e despesas (detalhe)",
    taxHint:"Editável",
    lblVpt:"VPT (opcional)",
    lblOther:"Outras despesas (€)",
    taxExplain:"IMT + Imposto do Selo (0,8%) + IS do crédito + outras despesas.",
    lblLoan:"Valor crédito habitação",
    lblLtv:"Percentagem de financiamento",
    lblPrice2:"Preço do imóvel",
    lblTaxes:"Impostos e despesas da compra",
    lblTotalCost:"Custo total do imóvel",
    lblSavingsBar:"A tua poupança disponível",
    lblCreditBar:"Crédito à Habitação",
    lblInterestBar:"Juro",
    legSavings:"Poupanças",
    legLoan:"Valor crédito habitação",
    legInterest:"Juros crédito habitação",
    lblTotalWithLoan:"Valor total com crédito habitação",
    amortLink:"Ver tabela de amortização",
    cta:"Encontrar crédito habitação",
    dlgTitle:"Tabela de amortização (estimativa)",
    close:"Fechar",
    thMonth:"Mês", thPayment:"Prestação", thInterest:"Juro", thPrincipal:"Capital", thBalance:"Saldo",
  },
  fr: {
    title:"Simulateur de crédit immobilier",
    cardTitle:"Ta mensualité",
    calcSpend:"Calculer combien tu peux dépenser",
    noteBank:"Les banques demandent souvent au minimum 10% d’apport + les frais.",
    lblPrice:"Prix du bien",
    lblSavings:"Épargne",
    lblYears:"Durée (années)",
    lblRateType:"Type de taux",
    lblFixed:"Fixe",
    lblVar:"Variable",
    lblEuribor:"Euribor (%)",
    lblSpread:"Spread (%)",
    lblRev:"Révision (mois)",
    varHint:"Estimation avec Euribor constant (tu peux ajouter des scénarios ensuite).",
    lblLoc:"Région",
    lblHouseType:"Type de bien",
    lblHpp:"Principale (HPP)",
    lblNonHpp:"Secondaire",
    lblAge:"35 ans ou moins ?",
    lblYes:"Oui",
    lblNo:"Non",
    lblTaxesBox:"Taxes et frais (détail)",
    taxHint:"Modifiable",
    lblVpt:"VPT (optionnel)",
    lblOther:"Autres frais (€)",
    taxExplain:"IMT + Imposto do Selo (0,8%) + IS du crédit + autres frais.",
    lblLoan:"Montant du crédit",
    lblLtv:"Pourcentage financé",
    lblPrice2:"Prix du bien",
    lblTaxes:"Taxes et frais d’achat",
    lblTotalCost:"Coût total du bien",
    lblSavingsBar:"Ton apport disponible",
    lblCreditBar:"Crédit",
    lblInterestBar:"Intérêts",
    legSavings:"Épargne",
    legLoan:"Montant du crédit",
    legInterest:"Intérêts du crédit",
    lblTotalWithLoan:"Total avec crédit",
    amortLink:"Voir le tableau d’amortissement",
    cta:"Trouver un crédit",
    dlgTitle:"Tableau d’amortissement (estimation)",
    close:"Fermer",
    thMonth:"Mois", thPayment:"Mensualité", thInterest:"Intérêt", thPrincipal:"Capital", thBalance:"Solde",
  }
};

function applyLang(lang){
  const d = I18N[lang];
  document.documentElement.lang = lang;
  setText("title", d.title);
  setText("cardTitle", d.cardTitle);
  setText("calcSpend", d.calcSpend);
  setText("noteBank", d.noteBank);
  setText("lblPrice", d.lblPrice);
  setText("lblSavings", d.lblSavings);
  setText("lblYears", d.lblYears);
  setText("lblRateType", d.lblRateType);
  setText("lblFixed", d.lblFixed);
  setText("lblVar", d.lblVar);
  setText("lblEuribor", d.lblEuribor);
  setText("lblSpread", d.lblSpread);
  setText("lblRev", d.lblRev);
  setText("varHint", d.varHint);
  setText("lblLoc", d.lblLoc);
  setText("lblHouseType", d.lblHouseType);
  setText("lblHpp", d.lblHpp);
  setText("lblNonHpp", d.lblNonHpp);
  setText("lblAge", d.lblAge);
  setText("lblYes", d.lblYes);
  setText("lblNo", d.lblNo);
  setText("lblTaxesBox", d.lblTaxesBox);
  setText("taxHint", d.taxHint);
  setText("lblVpt", d.lblVpt);
  setText("lblOther", d.lblOther);
  setText("taxExplain", d.taxExplain);
  setText("lblLoan", d.lblLoan);
  setText("lblLtv", d.lblLtv);
  setText("lblPrice2", d.lblPrice2);
  setText("lblTaxes", d.lblTaxes);
  setText("lblTotalCost", d.lblTotalCost);
  setText("lblSavingsBar", d.lblSavingsBar);
  setText("lblCreditBar", d.lblCreditBar);
  setText("lblInterestBar", d.lblInterestBar);
  setText("legSavings", d.legSavings);
  setText("legLoan", d.legLoan);
  setText("legInterest", d.legInterest);
  setText("lblTotalWithLoan", d.lblTotalWithLoan);
  setText("amortLink", d.amortLink);
  setText("cta", d.cta);
  setText("dlgTitle", d.dlgTitle);
  setText("closeDlg", d.close);
  setText("thMonth", d.thMonth);
  setText("thPayment", d.thPayment);
  setText("thInterest", d.thInterest);
  setText("thPrincipal", d.thPrincipal);
  setText("thBalance", d.thBalance);
}
function setText(id, txt){ const el=document.getElementById(id); if(el) el.textContent=txt; }

/** ==========================================
 *  2) IMT Tables (2026) — À REMPLIR (exact)
 *  ==========================================
 *  Format: [{ upTo, rate, deduction, flat }]
 *  - flat=true => IMT = base*rate
 *  - sinon     => IMT = base*rate - deduction
 */
const IMT_TABLES_2026 = {
  continente: {
    hpp: [
      // TODO: remplir avec les tranches 2026 exactes
      // Exemple fictif :
      // { upTo: 106346, rate: 0.00, deduction: 0, flat:false },
      // { upTo: 145470, rate: 0.02, deduction: 2126.92, flat:false },
      // ...
    ],
    nonhpp: [
      // TODO
    ]
  },
  acores: {
    hpp: [
      // TODO
    ],
    nonhpp: [
      // TODO
    ]
  }
};

function calcIMT(base, region, regime){
  const table = IMT_TABLES_2026?.[region]?.[regime] || [];
  if(!table.length) return 0; // tant que non rempli
  const row = table.find(x => x.upTo==null || base <= x.upTo) || table[table.length-1];
  if(row.flat) return base * row.rate;
  return Math.max(0, base * row.rate - (row.deduction || 0));
}

/** ===============================
 *  3) Imposto do Selo
 *  =============================== */
function stampPurchase(base){ return base * 0.008; } // 0,8%
function stampCredit(loanAmount, years){
  const months = Math.round(years*12);
  if(months < 12) return loanAmount * 0.0004 * months;
  if(months < 60) return loanAmount * 0.005;
  return loanAmount * 0.006;
}

/** ===============================
 *  4) Crédit (fixe / variable)
 *  =============================== */
function monthlyFixed(P, annualPct, years){
  const n = Math.round(years*12);
  const r = (annualPct/100)/12;
  if(P<=0) return 0;
  if(r===0) return P/n;
  return P * r / (1 - Math.pow(1+r, -n));
}

function simulateVariableConstant({principal, years, euribor, spread, revMonths}){
  let bal = principal;
  const totalMonths = Math.round(years*12);
  const annual = (euribor + spread);
  const r = (annual/100)/12;

  let totalInterest = 0;
  let m = 0;
  let firstMonthly = monthlyFixed(principal, annual, years);

  while(m < totalMonths && bal > 0.0001){
    const monthsLeft = totalMonths - m;
    const M = monthlyFixed(bal, annual, monthsLeft/12);
    const chunk = Math.min(revMonths, monthsLeft);
    for(let i=0;i<chunk;i++){
      const interest = bal * r;
      const amort = Math.max(0, M - interest);
      bal = Math.max(0, bal - amort);
      totalInterest += interest;
      m++;
      if(m>=totalMonths || bal<=0.0001) break;
    }
  }
  return { monthly0:firstMonthly, totalInterest };
}

/** ===============================
 *  5) UI logic
 *  =============================== */
const $ = (id)=>document.getElementById(id);

const nfPT = new Intl.NumberFormat('pt-PT',{style:'currency',currency:'EUR'});
const nfFR = new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR'});

function fmtEUR(v){
  const lang = $("lang").value;
  return (lang==="fr" ? nfFR : nfPT).format(v);
}

function syncRange(numEl, rangeEl){
  numEl.addEventListener('input', ()=>{ rangeEl.value = numEl.value; recompute(); });
  rangeEl.addEventListener('input', ()=>{ numEl.value = rangeEl.value; recompute(); });
}

function currentRatePct(){
  // rateBox holds for fixed; in variable we compute euribor+spread but keep rateBox as “display”
  return parseFloat($("rateBox").dataset.rate || "3.60");
}

function setRatePct(v){
  const vv = Math.max(0, Math.round(v*100)/100);
  $("rateBox").dataset.rate = vv.toFixed(2);
  $("rateBox").textContent = vv.toFixed(2).replace('.',',') + " %";
}

function getRadio(name){
  return [...document.querySelectorAll(`input[name="${name}"]`)].find(x=>x.checked)?.value;
}

function recompute(){
  const price = +$("price").value || 0;
  const savings = +$("savings").value || 0;
  const years = +$("years").value || 1;
  const vpt = $("vpt").value === "" ? 0 : (+$("vpt").value || 0);

  const region = $("region").value;       // continente | acores
  const regime = getRadio("use");         // hpp | nonhpp
  const rateType = getRadio("rateType");  // fixed | variable

  const base = Math.max(price, vpt);

  // Taxes
  const imt = calcIMT(base, region, regime);
  const isBuy = stampPurchase(base);
  const other = +$("otherFees").value || 0;

  const taxesAndFees = imt + isBuy + other;

  // Loan amount: mimic screenshot logic (property cost = price + taxes; savings is your own money)
  const totalCost = price + taxesAndFees;
  const loan = Math.max(0, totalCost - savings);
  const ltv = totalCost > 0 ? (loan / totalCost) : 0;

  // Credit stamp duty:
  const isCredit = stampCredit(loan, years);

  // Monthly & interest
  let monthly = 0;
  let totalInterest = 0;
  let amortPreview = [];

  if(rateType==="fixed"){
    const rate = currentRatePct();
    monthly = monthlyFixed(loan, rate, years);
    totalInterest = Math.max(0, monthly * Math.round(years*12) - loan);
    amortPreview = amortTableFixed(loan, rate, years, 240);
  }else{
    const euribor = +$("euribor").value || 0;
    const spread = +$("spread").value || 0;
    const rev = +$("rev").value || 12;
    const annual = euribor + spread;
    setRatePct(annual); // show the effective annual rate in the same box
    const sim = simulateVariableConstant({principal:loan, years, euribor, spread, revMonths:rev});
    monthly = sim.monthly0;
    totalInterest = sim.totalInterest;
    amortPreview = amortTableFixed(loan, annual, years, 240); // preview (approx)
  }

  const totalWithLoan = savings + (loan + totalInterest);

  // left: savings % of price like screenshot
  const pct = price>0 ? (savings/price*100) : 0;
  $("savingsPct").textContent = Math.round(pct) + "%";

  // Right outputs
  $("monthly").textContent = fmtEUR(monthly);
  $("loan").textContent = fmtEUR(loan);
  $("ltv").textContent = Math.round(ltv*100) + " %";

  $("priceOut").textContent = fmtEUR(price);
  $("taxesOut").textContent = fmtEUR(taxesAndFees);
  $("totalCost").textContent = fmtEUR(totalCost);

  $("legSavingsVal").textContent = fmtEUR(savings);
  $("legLoanVal").textContent = fmtEUR(loan);
  $("legInterestVal").textContent = fmtEUR(totalInterest);
  $("totalWithLoan").textContent = fmtEUR(totalWithLoan);

  // Bar segments: savings / loan / interest relative to (savings+loan+interest)
  const denom = Math.max(1, savings + loan + totalInterest);
  const wSav = (savings/denom)*100;
  const wLoan = (loan/denom)*100;
  const wInt = (totalInterest/denom)*100;
  $("segSavings").style.width = wSav + "%";
  $("segLoan").style.width = wLoan + "%";
  $("segInterest").style.width = wInt + "%";

  $("underSavings").textContent = fmtEUR(savings);
  $("underLoan").textContent = fmtEUR(loan);
  $("underInterest").textContent = fmtEUR(totalInterest);

  // store amortization preview for dialog
  window.__amort = amortPreview;
  window.__amortMeta = { monthly, years };
}

function amortTableFixed(P, annualPct, years, capRows){
  const n = Math.round(years*12);
  const r = (annualPct/100)/12;
  const M = monthlyFixed(P, annualPct, years);
  let bal = P;
  const rows = [];
  for(let i=1;i<=n;i++){
    const interest = bal * r;
    const principal = Math.max(0, M - interest);
    bal = Math.max(0, bal - principal);
    rows.push({i, pay:M, interest, principal, bal});
    if(rows.length >= capRows) break;
    if(bal<=0.0001) break;
  }
  return rows;
}

/** ===============================
 *  6) Event wiring
 *  =============================== */
syncRange($("price"), $("priceR"));
syncRange($("savings"), $("savingsR"));
syncRange($("years"), $("yearsR"));

$("minus").addEventListener("click", ()=>{ setRatePct(currentRatePct()-0.10); recompute(); });
$("plus").addEventListener("click", ()=>{ setRatePct(currentRatePct()+0.10); recompute(); });

document.querySelectorAll('input,select').forEach(el=>{
  el.addEventListener('input', ()=>{
    // show/hide variable box
    const rt = getRadio("rateType");
    $("varBox").style.display = (rt==="variable") ? "block" : "none";
    recompute();
  });
});

$("lang").addEventListener("change", ()=>{ applyLang($("lang").value); recompute(); });

$("amortLink").addEventListener("click", ()=>{
  const dlg = $("dlg");
  const body = $("tbody");
  body.innerHTML = "";
  const rows = window.__amort || [];
  for(const r of rows){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.i}</td>
      <td>${fmtEUR(r.pay)}</td>
      <td>${fmtEUR(r.interest)}</td>
      <td>${fmtEUR(r.principal)}</td>
      <td>${fmtEUR(r.bal)}</td>
    `;
    body.appendChild(tr);
  }
  dlg.showModal();
});
$("closeDlg").addEventListener("click", ()=> $("dlg").close());

$("fixed").addEventListener("change", ()=>{ $("varBox").style.display="none"; recompute(); });
$("variable").addEventListener("change", ()=>{ $("varBox").style.display="block"; recompute(); });

/** Init */
setRatePct(3.60);
applyLang("pt");
recompute();
</script>
</body>
</html>
