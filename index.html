<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Simulador de crédito habitação (PT/FR)</title>
  <style>
    :root{
      --green:#b5d200;
      --border:#e5e7eb;
      --muted:#6b7280;
      --card:#eef6ff;
      --btn:#a01873;
      --btn2:#8a1363;

      --barSavings:#86efac;
      --barLoan:#10b3b3;
      --barInterest:#0b7a7a;
      --barPrice:#f0cf00;
      --barTaxes:#c8a100;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#111827;background:#fff;}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px;}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:14px;}
    h1{font-size:28px;margin:0;font-weight:800;}
    .topright{display:flex;gap:14px;align-items:center;color:#2563eb;font-size:14px;white-space:nowrap}
    .topright a{color:#2563eb;text-decoration:none}
    .lang{display:flex;gap:8px;align-items:center}
    .lang select{padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff}

    .grid{display:grid;grid-template-columns:1.1fr 0.9fr;gap:22px;align-items:start;}
    @media (max-width: 960px){ .grid{grid-template-columns:1fr;} }

    .field{margin:14px 0;}
    .labelrow{display:flex;align-items:center;justify-content:space-between;gap:10px;}
    label{font-size:14px;color:#111827;font-weight:650;}
    .help{font-size:12px;color:var(--muted);}
    .inputrow{display:flex;align-items:center;gap:10px;margin-top:8px;}
    input[type="number"], input[type="text"], select{
      width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; font-size:16px;
    }
    .range{width:100%;appearance:none;height:6px;border-radius:999px;background:#dfe7c3; outline:none;}
    .range::-webkit-slider-thumb{
      appearance:none;width:22px;height:22px;border-radius:50%;
      background:var(--green); border:3px solid #93b600; cursor:pointer;
    }
    .miniLink{font-size:13px;color:#2563eb;text-decoration:none;}

    .note{
      background:#e9f4ff;border:1px solid #cfe7ff;color:#1f4e79;
      padding:10px 12px;border-radius:10px;font-size:13px;display:flex;gap:10px;align-items:flex-start;
    }
    .note .i{font-weight:900;line-height:1;margin-top:2px}

    .radioRow{display:flex;gap:14px;align-items:center;margin-top:8px;flex-wrap:wrap;}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;}
    .pill label{font-weight:650;font-size:14px;color:#374151}
    .rateBox{display:flex;align-items:center;gap:10px;margin-left:auto;}
    .rateBox button{
      width:36px;height:36px;border-radius:10px;border:1px solid var(--border);background:#fff;
      font-size:18px;cursor:pointer;
    }
    .rateBox .rate{
      min-width:110px;text-align:center;border:1px solid var(--border);border-radius:10px;padding:8px 10px;background:#fff;
      font-weight:800;
    }

    .card{background:var(--card);border:1px solid #d7e9ff;border-radius:12px;padding:16px;}
    .card h2{margin:0 0 8px 0;font-size:16px;font-weight:900;text-align:center;}
    .bigMoney{font-size:34px;font-weight:950;text-align:center;margin:0 0 14px 0;}
    .row{display:flex;justify-content:space-between;gap:12px;padding:8px 0;font-size:14px;}
    .row .mut{color:var(--muted)}
    .divider{height:1px;background:#d7e9ff;margin:10px 0;}

    .stackLegend{display:grid;grid-template-columns:16px 1fr auto;gap:10px;align-items:center;font-size:14px;padding:7px 0;}
    .sq{width:12px;height:12px;border-radius:3px;}

    .btn{
      width:100%; border:0; background:var(--btn); color:#fff; padding:12px 14px;
      border-radius:10px;font-weight:900;font-size:15px;cursor:pointer;
    }
    .btn:hover{background:var(--btn2);}
    .smallLink{display:inline-block;margin-top:8px;color:#2563eb;text-decoration:none;font-size:13px;}

    .barWrap{margin:10px 0 8px 0;}
    .barLabelRow{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-bottom:6px;}
    .bar{width:100%;height:18px;border-radius:999px;overflow:hidden;background:#e6eef7;border:1px solid #d7e9ff;display:flex;}
    .seg{height:100%;}
    .seg.savings{background:var(--barSavings);}
    .seg.loan{background:var(--barLoan);}
    .seg.interest{background:var(--barInterest);}
    .underBar{display:flex;justify-content:space-between;gap:10px;font-size:12px;color:var(--muted);margin-top:6px;}

    dialog{border:1px solid var(--border);border-radius:12px;max-width:820px;width:92vw;}
    dialog::backdrop{background:rgba(0,0,0,.35);}
    table{width:100%;border-collapse:collapse;font-size:13px;}
    th,td{padding:10px 8px;border-bottom:1px solid var(--border);text-align:right;}
    th:first-child, td:first-child{text-align:left;}
    .dlgTop{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px;}
    .x{border:1px solid var(--border);background:#fff;border-radius:10px;padding:8px 10px;cursor:pointer;}
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <h1 id="title">Simulador do crédito habitação</h1>
    <div class="topright">
      <a href="javascript:void(0)" id="legalLink">Intermediação de crédito · Informação legal</a>
      <div class="lang">
        <select id="lang">
          <option value="pt">PT</option>
          <option value="fr">FR</option>
        </select>
      </div>
    </div>
  </header>

  <div class="grid">
    <!-- LEFT -->
    <section>
      <div class="field">
        <div class="labelrow">
          <label id="lblPrice">Preço do imóvel</label>
          <input id="price" type="number" step="1000" min="0" value="300000" style="max-width:220px">
        </div>
        <div class="inputrow">
          <input class="range" id="priceR" type="range" min="50000" max="1500000" step="1000" value="300000">
        </div>
        <a class="miniLink" id="calcSpend" href="javascript:void(0)">Calcular o valor que podes gastar</a>
      </div>

      <div class="field">
        <div class="labelrow">
          <label id="lblSavings">Poupanças</label>
          <div style="display:flex;gap:10px;align-items:center;">
            <input id="savings" type="number" step="500" min="0" value="100000" style="max-width:220px">
            <div class="help" id="savingsPct">33%</div>
          </div>
        </div>
        <div class="inputrow">
          <input class="range" id="savingsR" type="range" min="0" max="800000" step="500" value="100000">
        </div>
        <div class="note" style="margin-top:10px">
          <div class="i">i</div>
          <div id="noteBank">Lembra-te que os bancos normalmente pedem uma contribuição mínima de 10% mais despesas.</div>
        </div>
      </div>

      <div class="field">
        <div class="labelrow">
          <label id="lblYears">Prazo em anos</label>
          <input id="years" type="number" min="1" max="40" value="25" style="max-width:220px">
        </div>
        <div class="inputrow">
          <input class="range" id="yearsR" type="range" min="1" max="40" step="1" value="25">
        </div>
      </div>

      <div class="field">
        <div class="labelrow"><label id="lblRateType">Tipo de taxa de juros</label></div>
        <div class="radioRow">
          <span class="pill">
            <input type="radio" name="rateType" id="fixed" value="fixed" checked>
            <label for="fixed" id="lblFixed">Fixa</label>
          </span>
          <span class="pill">
            <input type="radio" name="rateType" id="variable" value="variable">
            <label for="variable" id="lblVar">Variável</label>
          </span>

          <div class="rateBox">
            <button id="minus">−</button>
            <div class="rate" id="rateBox" data-fixed="3.60">3,60 %</div>
            <button id="plus">+</button>
          </div>
        </div>

        <div id="varBox" style="margin-top:10px;display:none">
          <div class="inputrow" style="gap:10px">
            <div style="flex:1">
              <div class="help" id="lblEuribor">Euribor (%)</div>
              <input id="euribor" type="number" step="0.01" value="3.00">
            </div>
            <div style="flex:1">
              <div class="help" id="lblSpread">Spread (%)</div>
              <input id="spread" type="number" step="0.01" value="1.00">
            </div>
            <div style="flex:1">
              <div class="help" id="lblRev">Revisão (meses)</div>
              <select id="rev">
                <option value="3">3</option>
                <option value="6">6</option>
                <option value="12" selected>12</option>
              </select>
            </div>
          </div>
          <div class="help" id="varHint" style="margin-top:6px">
            Estimativa com Euribor constante (podes depois adicionar cenários).
          </div>
        </div>
      </div>

      <div class="field">
        <div class="labelrow">
          <label id="lblLoc">Localização do imóvel</label>
          <select id="region" style="max-width:220px">
            <option value="continente" selected>Continente</option>
            <option value="acores">Açores</option>
          </select>
        </div>
      </div>

      <div class="field">
        <div class="labelrow"><label id="lblHouseType">Tipo de casa</label></div>
        <div class="radioRow">
          <span class="pill">
            <input type="radio" name="use" id="hpp" value="hpp">
            <label for="hpp" id="lblHpp">Principal (HPP)</label>
          </span>
          <span class="pill">
            <input type="radio" name="use" id="nonhpp" value="nonhpp" checked>
            <label for="nonhpp" id="lblNonHpp">Secundária</label>
          </span>
        </div>
      </div>

      <div class="field">
        <div class="labelrow"><label id="lblAge">Tens 35 anos ou menos?</label></div>
        <div class="radioRow">
          <span class="pill">
            <input type="radio" name="age" id="ageYes" value="yes">
            <label for="ageYes" id="lblYes">Sim</label>
          </span>
          <span class="pill">
            <input type="radio" name="age" id="ageNo" value="no" checked>
            <label for="ageNo" id="lblNo">Não</label>
          </span>
        </div>
      </div>

      <div class="field" style="margin-top:16px">
        <div class="labelrow">
          <label id="lblTaxesBox">Impostos e despesas (detalhe)</label>
          <div class="help" id="taxHint">Modificável</div>
        </div>
        <div class="inputrow" style="gap:10px">
          <div style="flex:1">
            <div class="help" id="lblVpt">VPT (opcional)</div>
            <input id="vpt" type="number" placeholder="—" step="1000">
          </div>
          <div style="flex:1">
            <div class="help" id="lblOther">Outras despesas (€)</div>
            <input id="otherFees" type="number" value="1500" step="50">
          </div>
        </div>
        <div class="help" style="margin-top:6px" id="taxExplain">
          IMT + Imposto do Selo (0,8%) + IS do crédito + outras despesas.
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <aside class="card">
      <h2 id="cardTitle">A tua prestação mensal</h2>
      <p class="bigMoney" id="monthly">—</p>

      <div class="row">
        <div><span id="lblLoan">Valor crédito habitação</span> <span class="muted">ⓘ</span></div>
        <div id="loan">—</div>
      </div>
      <div class="row">
        <div><span id="lblLtv">Percentagem de financiamento</span> <span class="muted">ⓘ</span></div>
        <div id="ltv">—</div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <div><span class="sq" style="background:var(--barPrice);display:inline-block;vertical-align:middle;margin-right:8px"></span><span id="lblPrice2">Preço do imóvel</span></div>
        <div id="priceOut">—</div>
      </div>
      <div class="row">
        <div><span class="sq" style="background:var(--barTaxes);display:inline-block;vertical-align:middle;margin-right:8px"></span><span id="lblTaxes">Impostos e despesas da compra</span> <span class="muted">ⓘ</span></div>
        <div id="taxesOut">—</div>
      </div>

      <div class="row" style="font-weight:950">
        <div id="lblTotalCost">Custo total do imóvel</div>
        <div id="totalCost">—</div>
      </div>

      <div class="barWrap">
        <div class="barLabelRow">
          <div id="lblSavingsBar">A tua poupança disponível</div>
          <div id="lblCreditBar">Crédito</div>
          <div id="lblInterestBar">Juro</div>
        </div>
        <div class="bar">
          <div class="seg savings" id="segSavings"></div>
          <div class="seg loan" id="segLoan"></div>
          <div class="seg interest" id="segInterest"></div>
        </div>
        <div class="underBar">
          <span id="underSavings"></span>
          <span id="underLoan"></span>
          <span id="underInterest"></span>
        </div>
      </div>

      <div class="stackLegend">
        <div class="sq" style="background:var(--barSavings)"></div>
        <div id="legSavings">Poupanças</div>
        <div id="legSavingsVal">—</div>
      </div>
      <div class="stackLegend">
        <div class="sq" style="background:var(--barLoan)"></div>
        <div id="legLoan">Valor crédito habitação</div>
        <div id="legLoanVal">—</div>
      </div>
      <div class="stackLegend">
        <div class="sq" style="background:var(--barInterest)"></div>
        <div id="legInterest">Juros crédito habitação</div>
        <div id="legInterestVal">—</div>
      </div>

      <div class="row" style="font-weight:950">
        <div id="lblTotalWithLoan">Valor total com crédito habitação</div>
        <div id="totalWithLoan">—</div>
      </div>

      <a class="smallLink" href="javascript:void(0)" id="amortLink">Ver tabela de amortização</a>

      <div style="height:10px"></div>
      <button class="btn" id="cta">Encontrar crédito habitação</button>
    </aside>
  </div>
</div>

<dialog id="dlg">
  <div class="dlgTop">
    <strong id="dlgTitle">Tabela de amortização (estimativa)</strong>
    <button class="x" id="closeDlg">Fechar</button>
  </div>
  <div style="max-height:60vh;overflow:auto">
    <table>
      <thead>
        <tr>
          <th id="thMonth">Mês</th>
          <th id="thPayment">Prestação</th>
          <th id="thInterest">Juro</th>
          <th id="thPrincipal">Capital</th>
          <th id="thBalance">Saldo</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</dialog>

<script>
/* ===============================
   I18N labels only
================================ */
const I18N = {
  pt: {
    title:"Simulador do crédito habitação",
    cardTitle:"A tua prestação mensal",
    calcSpend:"Calcular o valor que podes gastar",
    noteBank:"Lembra-te que os bancos normalmente pedem uma contribuição mínima de 10% mais despesas.",
    lblPrice:"Preço do imóvel",
    lblSavings:"Poupanças",
    lblYears:"Prazo em anos",
    lblRateType:"Tipo de taxa de juros",
    lblFixed:"Fixa",
    lblVar:"Variável",
    lblEuribor:"Euribor (%)",
    lblSpread:"Spread (%)",
    lblRev:"Revisão (meses)",
    varHint:"Estimativa com Euribor constante (podes depois adicionar cenários).",
    lblLoc:"Localização do imóvel",
    lblHouseType:"Tipo de casa",
    lblHpp:"Principal (HPP)",
    lblNonHpp:"Secundária",
    lblAge:"Tens 35 anos ou menos?",
    lblYes:"Sim",
    lblNo:"Não",
    lblTaxesBox:"Impostos e despesas (detalhe)",
    taxHint:"Modificável",
    lblVpt:"VPT (opcional)",
    lblOther:"Outras despesas (€)",
    taxExplain:"IMT + Imposto do Selo (0,8%) + IS do crédito + outras despesas.",
    lblLoan:"Valor crédito habitação",
    lblLtv:"Percentagem de financiamento",
    lblPrice2:"Preço do imóvel",
    lblTaxes:"Impostos e despesas da compra",
    lblTotalCost:"Custo total do imóvel",
    lblSavingsBar:"A tua poupança disponível",
    lblCreditBar:"Crédito",
    lblInterestBar:"Juro",
    legSavings:"Poupanças",
    legLoan:"Valor crédito habitação",
    legInterest:"Juros crédito habitação",
    lblTotalWithLoan:"Valor total com crédito habitação",
    amortLink:"Ver tabela de amortização",
    cta:"Encontrar crédito habitação",
    dlgTitle:"Tabela de amortização (estimativa)",
    close:"Fechar",
    thMonth:"Mês", thPayment:"Prestação", thInterest:"Juro", thPrincipal:"Capital", thBalance:"Saldo",
  },
  fr: {
    title:"Simulateur de crédit immobilier",
    cardTitle:"Ta mensualité",
    calcSpend:"Calculer combien tu peux dépenser",
    noteBank:"Les banques demandent souvent au minimum 10% d’apport + les frais.",
    lblPrice:"Prix du bien",
    lblSavings:"Épargne",
    lblYears:"Durée (années)",
    lblRateType:"Type de taux",
    lblFixed:"Fixe",
    lblVar:"Variable",
    lblEuribor:"Euribor (%)",
    lblSpread:"Spread (%)",
    lblRev:"Révision (mois)",
    varHint:"Estimation avec Euribor constant (tu peux ajouter des scénarios ensuite).",
    lblLoc:"Région",
    lblHouseType:"Type de bien",
    lblHpp:"Principale (HPP)",
    lblNonHpp:"Secondaire",
    lblAge:"35 ans ou moins ?",
    lblYes:"Oui",
    lblNo:"Non",
    lblTaxesBox:"Taxes et frais (détail)",
    taxHint:"Modifiable",
    lblVpt:"VPT (optionnel)",
    lblOther:"Autres frais (€)",
    taxExplain:"IMT + Imposto do Selo (0,8%) + IS du crédit + autres frais.",
    lblLoan:"Montant du crédit",
    lblLtv:"Pourcentage financé",
    lblPrice2:"Prix du bien",
    lblTaxes:"Taxes et frais d’achat",
    lblTotalCost:"Coût total du bien",
    lblSavingsBar:"Ton apport disponible",
    lblCreditBar:"Crédit",
    lblInterestBar:"Intérêts",
    legSavings:"Épargne",
    legLoan:"Montant du crédit",
    legInterest:"Intérêts du crédit",
    lblTotalWithLoan:"Total avec crédit",
    amortLink:"Voir le tableau d’amortissement",
    cta:"Trouver un crédit",
    dlgTitle:"Tableau d’amortissement (estimation)",
    close:"Fermer",
    thMonth:"Mois", thPayment:"Mensualité", thInterest:"Intérêt", thPrincipal:"Capital", thBalance:"Solde",
  }
};

function setText(id, txt){ const el=document.getElementById(id); if(el) el.textContent=txt; }
function applyLang(lang){
  const d = I18N[lang];
  document.documentElement.lang = lang;
  setText("title", d.title);
  setText("cardTitle", d.cardTitle);
  setText("calcSpend", d.calcSpend);
  setText("noteBank", d.noteBank);
  setText("lblPrice", d.lblPrice);
  setText("lblSavings", d.lblSavings);
  setText("lblYears", d.lblYears);
  setText("lblRateType", d.lblRateType);
  setText("lblFixed", d.lblFixed);
  setText("lblVar", d.lblVar);
  setText("lblEuribor", d.lblEuribor);
  setText("lblSpread", d.lblSpread);
  setText("lblRev", d.lblRev);
  setText("varHint", d.varHint);
  setText("lblLoc", d.lblLoc);
  setText("lblHouseType", d.lblHouseType);
  setText("lblHpp", d.lblHpp);
  setText("lblNonHpp", d.lblNonHpp);
  setText("lblAge", d.lblAge);
  setText("lblYes", d.lblYes);
  setText("lblNo", d.lblNo);
  setText("lblTaxesBox", d.lblTaxesBox);
  setText("taxHint", d.taxHint);
  setText("lblVpt", d.lblVpt);
  setText("lblOther", d.lblOther);
  setText("taxExplain", d.taxExplain);
  setText("lblLoan", d.lblLoan);
  setText("lblLtv", d.lblLtv);
  setText("lblPrice2", d.lblPrice2);
  setText("lblTaxes", d.lblTaxes);
  setText("lblTotalCost", d.lblTotalCost);
  setText("lblSavingsBar", d.lblSavingsBar);
  setText("lblCreditBar", d.lblCreditBar);
  setText("lblInterestBar", d.lblInterestBar);
  setText("legSavings", d.legSavings);
  setText("legLoan", d.legLoan);
  setText("legInterest", d.legInterest);
  setText("lblTotalWithLoan", d.lblTotalWithLoan);
  setText("amortLink", d.amortLink);
  setText("cta", d.cta);
  setText("dlgTitle", d.dlgTitle);
  setText("closeDlg", d.close);
  setText("thMonth", d.thMonth);
  setText("thPayment", d.thPayment);
  setText("thInterest", d.thInterest);
  setText("thPrincipal", d.thPrincipal);
  setText("thBalance", d.thBalance);
}

/* ===============================
   IMT tables 2026 (Continente + Açores)
   Format: IMT = base*rate - deduction (or base*rate if flat=true)
================================ */
const IMT_TABLES_2026 = {
  continente: {
    hpp: [
      { upTo: 106346, rate: 0.00, deduction: 0.00, flat: false },
      { upTo: 145470, rate: 0.02, deduction: 2126.92, flat: false },
      { upTo: 198347, rate: 0.05, deduction: 6491.04, flat: false },
      { upTo: 330539, rate: 0.07, deduction: 10457.98, flat: false },
      { upTo: 660982, rate: 0.08, deduction: 13763.37, flat: false },
      { upTo: 1150853, rate: 0.06, deduction: 0.00, flat: true },
      { upTo: null, rate: 0.075, deduction: 0.00, flat: true }
    ],
    nonhpp: [
      { upTo: 106346, rate: 0.01, deduction: 0.00, flat: false },
      { upTo: 145470, rate: 0.02, deduction: 1063.46, flat: false },
      { upTo: 198347, rate: 0.05, deduction: 5427.57, flat: false },
      { upTo: 330539, rate: 0.07, deduction: 9394.52, flat: false },
      { upTo: 633931, rate: 0.08, deduction: 12699.91, flat: false },
      { upTo: 1150853, rate: 0.06, deduction: 0.00, flat: true },
      { upTo: null, rate: 0.075, deduction: 0.00, flat: true }
    ]
  },
  acores: {
    hpp: [
      { upTo: 132933, rate: 0.00, deduction: 0.00, flat: false },
      { upTo: 181838, rate: 0.02, deduction: 2658.65, flat: false },
      { upTo: 247934, rate: 0.05, deduction: 8113.80, flat: false },
      { upTo: 413174, rate: 0.07, deduction: 13072.49, flat: false },
      { upTo: 826229, rate: 0.08, deduction: 17204.24, flat: false },
      { upTo: 1438566, rate: 0.06, deduction: 0.00, flat: true },
      { upTo: null, rate: 0.075, deduction: 0.00, flat: true }
    ],
    nonhpp: [
      { upTo: 132933, rate: 0.01, deduction: 0.00, flat: false },
      { upTo: 181838, rate: 0.02, deduction: 1329.33, flat: false },
      { upTo: 247934, rate: 0.05, deduction: 6784.48, flat: false },
      { upTo: 413174, rate: 0.07, deduction: 11743.17, flat: false },
      { upTo: 792414, rate: 0.08, deduction: 15874.91, flat: false },
      { upTo: 1438566, rate: 0.06, deduction: 0.00, flat: true },
      { upTo: null, rate: 0.075, deduction: 0.00, flat: true }
    ]
  }
};

function calcIMT(base, region, regime){
  const table = IMT_TABLES_2026[region][regime];
  const row = table.find(x => x.upTo === null || base <= x.upTo) || table[table.length-1];
  if(row.flat) return base * row.rate;
  return Math.max(0, base * row.rate - (row.deduction || 0));
}

/* ===============================
   Imposto do Selo
================================ */
function stampPurchase(base){ return base * 0.008; } // 0,8%
function stampCredit(loanAmount, years){
  const months = Math.round(years*12);
  if(months < 12) return loanAmount * 0.0004 * months; // 0,04%/mês
  if(months < 60) return loanAmount * 0.005;          // 0,50%
  return loanAmount * 0.006;                           // 0,60%
}

/* ===============================
   Mortgage calculations
================================ */
function monthlyFixed(P, annualPct, years){
  const n = Math.round(years*12);
  const r = (annualPct/100)/12;
  if(P<=0) return 0;
  if(r===0) return P/n;
  return P * r / (1 - Math.pow(1+r, -n));
}

function simulateVariableConstant({principal, years, euribor, spread, revMonths}){
  let bal = principal;
  const totalMonths = Math.round(years*12);
  const annual = (euribor + spread);
  const r = (annual/100)/12;

  let totalInterest = 0;
  let m = 0;
  const firstMonthly = monthlyFixed(principal, annual, years);

  while(m < totalMonths && bal > 0.0001){
    const monthsLeft = totalMonths - m;
    const M = monthlyFixed(bal, annual, monthsLeft/12);
    const chunk = Math.min(revMonths, monthsLeft);
    for(let i=0;i<chunk;i++){
      const interest = bal * r;
      const amort = Math.max(0, M - interest);
      bal = Math.max(0, bal - amort);
      totalInterest += interest;
      m++;
      if(m>=totalMonths || bal<=0.0001) break;
    }
  }
  return { monthly0:firstMonthly, totalInterest };
}

function amortTableFixed(P, annualPct, years, capRows){
  const n = Math.round(years*12);
  const r = (annualPct/100)/12;
  const M = monthlyFixed(P, annualPct, years);
  let bal = P;
  const rows = [];
  for(let i=1;i<=n;i++){
    const interest = bal * r;
    const principal = Math.max(0, M - interest);
    bal = Math.max(0, bal - principal);
    rows.push({i, pay:M, interest, principal, bal});
    if(rows.length >= capRows) break;
    if(bal<=0.0001) break;
  }
  return rows;
}

/* ===============================
   UI helpers
================================ */
const $ = (id)=>document.getElementById(id);
const nfPT = new Intl.NumberFormat('pt-PT',{style:'currency',currency:'EUR'});
const nfFR = new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR'});
function fmtEUR(v){
  const lang = $("lang").value;
  return (lang==="fr" ? nfFR : nfPT).format(v);
}
function syncRange(numEl, rangeEl){
  numEl.addEventListener('input', ()=>{ rangeEl.value = numEl.value; recompute(); });
  rangeEl.addEventListener('input', ()=>{ numEl.value = rangeEl.value; recompute(); });
}
function getRadio(name){
  return [...document.querySelectorAll(`input[name="${name}"]`)].find(x=>x.checked)?.value;
}
function setFixedRatePct(v){
  const vv = Math.max(0, Math.round(v*100)/100);
  $("rateBox").dataset.fixed = vv.toFixed(2);
  const show = vv.toFixed(2).replace('.',',') + " %";
  $("rateBox").textContent = show;
}
function getFixedRatePct(){
  return parseFloat($("rateBox").dataset.fixed || "3.60");
}

/* ===============================
   Main recompute
================================ */
function recompute(){
  const price = +$("price").value || 0;
  const savings = +$("savings").value || 0;
  const years = +$("years").value || 1;
  const vpt = $("vpt").value === "" ? 0 : (+$("vpt").value || 0);

  const region = $("region").value;        // continente | acores
  const regime = getRadio("use");          // hpp | nonhpp
  const rateType = getRadio("rateType");   // fixed | variable

  const base = Math.max(price, vpt);

  const imt = calcIMT(base, region, regime);
  const isBuy = stampPurchase(base);
  const other = +$("otherFees").value || 0;

  // Like the screenshot: "Impostos e despesas da compra" = IMT + IS (0,8%) + outras despesas
  const taxesAndFees = imt + isBuy + other;

  const totalCost = price + taxesAndFees;
  const loan = Math.max(0, totalCost - savings);
  const ltv = totalCost > 0 ? (loan / totalCost) : 0;

  // stamp duty on credit (not included in "taxesAndFees" by default, but used in background)
  const isCredit = stampCredit(loan, years);

  let monthly = 0;
  let totalInterest = 0;

  if(rateType==="fixed"){
    $("varBox").style.display = "none";
    const rate = getFixedRatePct();
    monthly = monthlyFixed(loan, rate, years);
    totalInterest = Math.max(0, monthly * Math.round(years*12) - loan);
    window.__amort = amortTableFixed(loan, rate, years, 360);
  }else{
    $("varBox").style.display = "block";
    const euribor = +$("euribor").value || 0;
    const spread = +$("spread").value || 0;
    const rev = +$("rev").value || 12;
    const annual = euribor + spread;

    const sim = simulateVariableConstant({principal:loan, years, euribor, spread, revMonths:rev});
    monthly = sim.monthly0;
    totalInterest = sim.totalInterest;

    // amort preview approximated with constant annual (Euribor constant)
    window.__amort = amortTableFixed(loan, annual, years, 360);
  }

  const totalWithLoan = savings + (loan + totalInterest);

  // left: savings % of price (like screenshot)
  const pct = price>0 ? (savings/price*100) : 0;
  $("savingsPct").textContent = Math.round(pct) + "%";

  // Right outputs
  $("monthly").textContent = fmtEUR(monthly);
  $("loan").textContent = fmtEUR(loan);
  $("ltv").textContent = Math.round(ltv*100) + " %";
  $("priceOut").textContent = fmtEUR(price);
  $("taxesOut").textContent = fmtEUR(taxesAndFees);
  $("totalCost").textContent = fmtEUR(totalCost);

  $("legSavingsVal").textContent = fmtEUR(savings);
  $("legLoanVal").textContent = fmtEUR(loan);
  $("legInterestVal").textContent = fmtEUR(totalInterest);
  $("totalWithLoan").textContent = fmtEUR(totalWithLoan);

  // Bar segments: savings / loan / interest relative to (savings+loan+interest)
  const denom = Math.max(1, savings + loan + totalInterest);
  $("segSavings").style.width = (savings/denom*100) + "%";
  $("segLoan").style.width = (loan/denom*100) + "%";
  $("segInterest").style.width = (totalInterest/denom*100) + "%";

  $("underSavings").textContent = fmtEUR(savings);
  $("underLoan").textContent = fmtEUR(loan);
  $("underInterest").textContent = fmtEUR(totalInterest);

  // (optional) keep credit stamp duty computed for future display if you want:
  window.__isCredit = isCredit;
}

/* ===============================
   Wiring
================================ */
syncRange($("price"), $("priceR"));
syncRange($("savings"), $("savingsR"));
syncRange($("years"), $("yearsR"));

$("minus").addEventListener("click", ()=>{ setFixedRatePct(getFixedRatePct()-0.10); recompute(); });
$("plus").addEventListener("click", ()=>{ setFixedRatePct(getFixedRatePct()+0.10); recompute(); });

document.querySelectorAll('input,select').forEach(el=>{
  el.addEventListener('input', ()=>recompute());
});

$("fixed").addEventListener("change", ()=>recompute());
$("variable").addEventListener("change", ()=>recompute());

$("lang").addEventListener("change", ()=>{
  applyLang($("lang").value);
  recompute();
});

$("amortLink").addEventListener("click", ()=>{
  const dlg = $("dlg");
  const body = $("tbody");
  body.innerHTML = "";
  const rows = window.__amort || [];
  for(const r of rows){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.i}</td>
      <td>${fmtEUR(r.pay)}</td>
      <td>${fmtEUR(r.interest)}</td>
      <td>${fmtEUR(r.principal)}</td>
      <td>${fmtEUR(r.bal)}</td>
    `;
    body.appendChild(tr);
  }
  dlg.showModal();
});
$("closeDlg").addEventListener("click", ()=> $("dlg").close());

/* init */
setFixedRatePct(3.60);
applyLang("pt");
recompute();
</script>
</body>
</html>
